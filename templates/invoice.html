<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sales Tax Invoice</title>

    <style>
      /* ---------- PAGE SETUP ---------- */
      @page {
        size: A4;
        margin: 10mm;
      }

      body {
        margin-top: 15%;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 10px;
        color: #000;
        line-height: 1.3;
      }

      /* ---------- HEADER ---------- */
      .header-title {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #000;
        padding-bottom: 10px;
      }

      .header-title h1 {
        margin: 0;
        font-size: 24px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* ---------- INVOICE META ---------- */
      .invoice-meta-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        font-size: 11px;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
      }

      /* ---------- SELLER & BUYER ---------- */
      .parties-section {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 20px;
      }

      .party-box {
        width: 48%;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 4px;
        background-color: #fcfcfc;
      }

      .party-title {
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 8px;
        border-bottom: 1px solid #eee;
        padding-bottom: 2px;
        font-size: 11px;
      }

      .compact-table {
        width: 100%;
        border-collapse: collapse;
      }
      .compact-table td {
        padding: 2px 0;
        vertical-align: top;
      }
      .compact-table .label {
        font-weight: bold;
        color: #555;
        white-space: nowrap;
        width: 1%;
        padding-right: 8px;
      }
      .compact-table .value {
        color: #000;
      }

      /* ---------- ITEMS TABLE ---------- */
      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
      }

      .items-table th {
        border: 1px solid #000;
        background-color: #eaeaea;
        color: #000;
        font-weight: bold;
        text-align: center;
        padding: 6px 2px;
        font-size: 9px;
      }

      .items-table td {
        border: 1px solid #000;
        padding: 5px 2px;
        font-size: 9px;
        text-align: center;
        vertical-align: middle;
      }

      .text-left { text-align: left !important; padding-left: 5px !important; }
      
      .hs-code-tag {
        font-size: 8px;
        color: #666;
        margin-left: 5px;
      }

      /* ---------- FOOTER SECTION ---------- */
      .footer-section {
        margin-top: 10px;
      }

      .totals-container {
        display: flex;
        justify-content: flex-end;
      }

      .totals-table {
        width: 300px;
        border-collapse: collapse;
      }
      .totals-table td {
        padding: 3px;
        font-size: 11px;
      }
      .totals-label { text-align: right; padding-right: 10px; font-weight: bold; }
      .totals-value { text-align: right; border-bottom: 1px solid #eee; }
      
      .grand-total {
        border-top: 2px solid #000;
        border-bottom: 2px double #000;
        font-weight: bold;
        font-size: 12px;
      }

      /* ---------- BRANDING (SIDE BY SIDE) ---------- */
      .bottom-branding {
        margin-top: 40px;
        display: flex;
        flex-direction: row; /* Makes items Horizontal */
        align-items: center; /* Vertically center them */
        justify-content: center; /* Center the group on page */
        gap: 40px; /* Space between Logo and QR */
        page-break-inside: avoid;
      }

      .logo-img {
        height: 70px; 
        width: auto;
      }

      .qr-wrapper {
        text-align: center;
      }

      .qr-img {
        width: 90px;
        height: 90px;
        border: 1px solid #ccc;
        padding: 2px;
        display: block; /* Helps with alignment inside wrapper */
      }

      .disclaimer {
        margin-top: 15px;
        text-align: center;
        font-size: 8px;
        color: #777;
        width: 100%;
        border-top: 1px solid #eee;
        padding-top: 5px;
      }

      /* UTILS */
      .no-break { page-break-inside: avoid; }
    </style>
  </head>

  <body>

    <div class="header-title">
      <h1>SALES TAX INVOICE</h1>
    </div>

    <div class="invoice-meta-bar">
      <div>Invoice No: {{ invoice.invoice_number if invoice.invoice_number else invoice.get("invoiceNumber", "Pending") }}</div>
      <div>Ref No: {{ invoice.payload.get("invoiceRefNo", "N/A") }}</div>
      <div>Date: {{ invoice.payload.get("invoiceDate") }}</div>
    </div>

    <div class="parties-section">
      <div class="party-box">
        <div class="party-title">Seller Information</div>
        <table class="compact-table">
          <tr>
            <td class="label">Name:</td>
            <td class="value">{{ invoice.payload.get("sellerBusinessName", "SELLER NAME") }}</td>
          </tr>
          <tr>
            <td class="label">Address:</td>
            <td class="value">{{ invoice.payload.get("sellerAddress") }}, {{ invoice.payload.get("sellerProvince") }}</td>
          </tr>
          <tr>
            <td class="label">NTN:</td>
            <td class="value">{{ invoice.payload.get("sellerNTNCNIC") }}</td>
          </tr>
        </table>
      </div>

      <div class="party-box">
        <div class="party-title">Buyer Information</div>
        <table class="compact-table">
          <tr>
            <td class="label">Name:</td>
            <td class="value">{{ invoice.payload.get("buyerBusinessName") }}</td>
          </tr>
          <tr>
            <td class="label">Address:</td>
            <td class="value">{{ invoice.payload.get("buyerAddress") }}, {{ invoice.payload.get("buyerProvince") }}</td>
          </tr>
          <tr>
            <td class="label">NTN/CNIC:</td>
            <td class="value">{{ invoice.payload.get("buyerNTNCNIC") }}</td>
          </tr>
          <tr>
            <td class="label">Type:</td>
            <td class="value">{{ invoice.payload.get("buyerRegistrationType", "Unregistered") }}</td>
          </tr>
        </table>
      </div>
    </div>

    <table class="items-table">
      <thead>
        <tr>
          <th style="width: 3%">#</th>
          <th style="width: 25%">Description</th>
          <th style="width: 8%">Unit Price<br>(Excl. ST)</th>
          <th style="width: 5%">Qty</th>
          <th style="width: 5%">Units</th>
          <th style="width: 10%">Total Price<br>(Unit*Qty)</th>
          <th style="width: 6%">Discount</th>
          <th style="width: 6%">Rate(%)</th>
          <th style="width: 8%">Sales Tax</th>
          <th style="width: 8%">Further Tax</th>
          <th style="width: 12%">Total<br>(Incl. Tax)</th>
        </tr>
      </thead>
      <tbody>
        {% set totals = namespace(value=0, tax=0, discount=0, further=0, fed=0, final=0) %} 
        
        {% for item in invoice.payload.get("items",[]) %} 
            {% set val = item.get("valueSalesExcludingST",0)|float %} 
            {% set qty = item.get("quantity",1)|float %} 
            {% set tax = item.get("salesTaxApplicable",0)|float %} 
            {% set disc = item.get("discount",0)|float %} 
            {% set fur = item.get("furtherTax",0)|float %} 
            
            {% set unit_price = val / qty if qty > 0 else 0 %}
            {% set row_total_incl = (val + tax + fur) - disc %}
            
            {% set totals.value = totals.value + val %} 
            {% set totals.tax = totals.tax + tax %} 
            {% set totals.discount = totals.discount + disc %} 
            {% set totals.further = totals.further + fur %} 
            {% set totals.final = totals.final + row_total_incl %}

        <tr>
          <td>{{ loop.index }}</td>
          <td class="text-left">
            {{ item.get("productDescription","") }}
            {% if item.get("hsCode") %}
              <span class="hs-code-tag">({{ item.get("hsCode") }})</span>
            {% endif %}
          </td>
          <td>{{ "%.2f"|format(unit_price) }}</td>
          <td>{{ item.get("quantity",0) }}</td>
          <td>{{ item.get("uoM","") }}</td>
          <td>{{ "%.2f"|format(val) }}</td>
          <td>{{ "%.2f"|format(disc) if disc > 0 else "-" }}</td>
          <td>{{ item.get("rate", 0) }}</td>
          <td>{{ "%.2f"|format(tax) }}</td>
          <td>{{ "%.2f"|format(fur) if fur > 0 else "-" }}</td>
          <td><b>{{ "%.2f"|format(row_total_incl) }}</b></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="footer-section no-break">
      <div class="totals-container">
        <table class="totals-table">
            <tr>
                <td class="totals-label">Total Value (Excl. ST):</td>
                <td class="totals-value">{{ "%.2f"|format(totals.value) }}</td>
            </tr>
            {% if totals.discount > 0 %}
            <tr>
                <td class="totals-label">Discount:</td>
                <td class="totals-value">({{ "%.2f"|format(totals.discount) }})</td>
            </tr>
            {% endif %}
            <tr>
                <td class="totals-label">Total Sales Tax:</td>
                <td class="totals-value">{{ "%.2f"|format(totals.tax) }}</td>
            </tr>
            {% if totals.further > 0 %}
            <tr>
                <td class="totals-label">Further Tax:</td>
                <td class="totals-value">{{ "%.2f"|format(totals.further) }}</td>
            </tr>
            {% endif %}
            <tr class="grand-total">
                <td class="totals-label" style="padding-top:5px; border:none;">Grand Total:</td>
                <td class="totals-value" style="padding-top:5px; border:none;">{{ "%.2f"|format(totals.final) }}</td>
            </tr>
        </table>
      </div>

      <div class="bottom-branding">
        <img src="file:///home/abdullah/Project/static/images/fbr_logo.jpg" alt="Logo" class="logo-img" />
        
        {% if invoice.qr_code %}
        <div class="qr-wrapper">
          <img src="{{ invoice.qr_code }}" alt="QR Code" class="qr-img" />
          <div style="font-size: 8px; margin-top: 5px;">Scan to Verify</div>
        </div>
        {% endif %}
      </div>
      
      <div class="disclaimer">
          System Generated Invoice - FBR Verified
      </div>
    </div>

  </body>
</html>